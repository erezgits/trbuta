<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="××©×¤×—×”">
<meta name="theme-color" content="#1a1a1a">
<title>××©×¤×—×” ×‘×™×—×“</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{--black:#1a1a1a;--warm:#f0ebe4;--g1:#f5f2ef;--g2:#e8e3dc;--g3:#b8b0a6;--g4:#6b6560;--green:#2d6a4f;--green-bg:#e8f5ee;--red:#c0392b;--red-bg:#fdecea;--amber:#b45309;--amber-bg:#fef3c7;--nav:68px;--safe-t:env(safe-area-inset-top,0px);--safe-b:env(safe-area-inset-bottom,0px)}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;overscroll-behavior:none}
body{font-family:'Heebo',system-ui,sans-serif;background:var(--warm);color:var(--black);direction:rtl;-webkit-font-smoothing:antialiased}
#app{position:fixed;inset:0;display:flex;flex-direction:column;max-width:430px;margin:0 auto;background:var(--warm)}
.safe-top{height:var(--safe-t);background:var(--black);flex-shrink:0}
#loading{position:fixed;inset:0;background:var(--black);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:16px}
#loading .logo{font-size:2.5rem}
#loading .txt{color:#fff;font-size:1rem;font-weight:700;opacity:.7}
#loading .spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loading.hide{animation:fadeout .3s forwards;pointer-events:none}
@keyframes fadeout{to{opacity:0}}
#syncDot{position:fixed;top:calc(var(--safe-t)+8px);left:12px;width:8px;height:8px;border-radius:50%;background:#2d6a4f;z-index:100;transition:background .3s}
#syncDot.syncing{background:#d4783a;animation:pulse .8s infinite}
#syncDot.error{background:#c0392b}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.hdr{background:var(--black);color:#fff;padding:12px 18px 14px;flex-shrink:0}
.hdr-row{display:flex;align-items:center;justify-content:space-between}
.hdr-title{font-size:1.25rem;font-weight:900;letter-spacing:-.5px}
.hdr-sub{font-size:.65rem;opacity:.4;margin-top:2px}
.hdr-btns{display:flex;gap:6px}
.hdr-btn{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#fff;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;flex-shrink:0}
.bell-pip{position:absolute;top:5px;right:5px;width:8px;height:8px;border-radius:50%;background:#ff5f5f;border:2px solid var(--black);display:none}
.bell-pip.show{display:block}
.who-bar{background:rgba(255,255,255,.08);border-top:1px solid rgba(255,255,255,.08);padding:7px 18px;display:flex;align-items:center;gap:8px;flex-shrink:0;cursor:pointer}
.who-av{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.58rem;font-weight:900;color:#fff;flex-shrink:0}
.who-name{font-size:.78rem;font-weight:700;color:rgba(255,255,255,.8);flex:1}
.who-change{font-size:.68rem;color:rgba(255,255,255,.4);text-decoration:underline}
.filter-bar{background:var(--black);padding:0 14px 11px;display:flex;gap:6px;overflow-x:auto;flex-shrink:0}
.filter-bar::-webkit-scrollbar{display:none}
.fb-btn{padding:5px 13px;border-radius:20px;border:1.5px solid rgba(255,255,255,.2);background:transparent;color:rgba(255,255,255,.5);font-family:'Heebo',sans-serif;font-size:.75rem;font-weight:700;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .2s}
.fb-btn.on{background:#fff;color:var(--black);border-color:#fff}
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;padding-bottom:calc(var(--nav) + var(--safe-b) + 12px)}
.scroll::-webkit-scrollbar{display:none}
.nav{position:absolute;bottom:0;left:0;right:0;background:var(--black);display:flex;padding-bottom:var(--safe-b);z-index:50}
.nav-btn{flex:1;border:none;background:none;cursor:pointer;color:rgba(255,255,255,.35);display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px 8px;font-family:'Heebo',sans-serif;font-size:.58rem;font-weight:700;transition:color .2s;min-height:var(--nav);position:relative}
.nav-btn.on{color:#fff}
.nav-icon{font-size:1.2rem;line-height:1;position:relative}
.nav-pip{position:absolute;top:-3px;right:-7px;min-width:16px;height:16px;background:#ff5f5f;color:#fff;border-radius:8px;font-size:.56rem;font-weight:900;display:none;align-items:center;justify-content:center;padding:0 3px}
.nav-pip.show{display:flex}
.nav-tick{width:3px;height:3px;border-radius:50%;background:#fff;opacity:0;margin-top:1px;transition:opacity .2s}
.nav-btn.on .nav-tick{opacity:1}
.page{display:none;padding:16px 0 0}
.page.on{display:block;animation:pg .2s ease}
@keyframes pg{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.pg-hdr{padding:0 16px 12px;display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
.pg-label{font-size:1.8rem;font-weight:900;letter-spacing:-1px;line-height:1}
.pg-sub{font-size:.72rem;color:var(--g4);margin-top:3px}
.pg-add{width:42px;height:42px;border-radius:13px;background:var(--black);color:#fff;border:none;font-size:1.3rem;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(0,0,0,.22);transition:transform .15s}
.pg-add:active{transform:scale(.9)}
.card{background:#fff;border-radius:18px;margin:0 12px 12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06),0 4px 14px rgba(0,0,0,.06)}
.ev-strip{height:5px}
.ev-top{padding:13px 16px 9px}
.ev-name{font-size:.98rem;font-weight:800;line-height:1.25;letter-spacing:-.2px}
.ev-meta{font-size:.75rem;color:var(--g4);margin-top:4px;font-weight:500;display:flex;flex-direction:column;gap:2px}
.ev-note{margin:6px 16px 0;background:var(--g1);border-radius:10px;padding:8px 12px;font-size:.74rem;color:var(--g4);line-height:1.5}
.invited-fams{display:flex;flex-wrap:wrap;gap:5px;padding:7px 16px 8px}
.inv-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:9px;font-size:.68rem;font-weight:800;color:#fff}
.inv-tag-all{background:var(--black)}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;padding:10px 12px 8px}
.stat{background:var(--g1);border-radius:11px;padding:8px 4px;text-align:center}
.stat-n{font-size:1.3rem;font-weight:900;line-height:1}
.stat-l{font-size:.56rem;font-weight:700;color:var(--g4);margin-top:2px}
.cg{color:var(--green)}.cr{color:var(--red)}.ca{color:var(--amber)}.cm{color:var(--g3)}
.fam-breakdown{padding:6px 12px 10px}
.fam-breakdown-hdr{font-size:.64rem;font-weight:800;color:var(--g4);letter-spacing:.4px;text-transform:uppercase;margin-bottom:6px}
.fam-bd-row{display:flex;align-items:center;gap:8px;padding:5px 2px;border-bottom:1px solid var(--g1)}
.fam-bd-row:last-child{border-bottom:none}
.fam-bd-name{font-size:.78rem;font-weight:700;min-width:90px;display:flex;align-items:center;gap:5px}
.fam-bd-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.fam-bd-avatars{display:flex;flex:1;flex-wrap:wrap;gap:2px}
.fam-bd-av{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:900;color:#fff;border:2px solid #fff;flex-shrink:0}
.fam-bd-count{font-size:.7rem;font-weight:700;color:var(--g4);white-space:nowrap}
.ev-actions{padding:4px 12px 4px;display:flex;gap:6px;align-items:center}
.rsvp-opt{flex:1;padding:9px 4px;border-radius:11px;border:2px solid var(--g2);background:#fff;font-family:'Heebo',sans-serif;font-size:.78rem;font-weight:700;color:var(--g4);cursor:pointer;text-align:center;transition:all .15s}
.rsvp-opt:active{transform:scale(.95)}
.rsvp-opt.on-yes{border-color:var(--green);background:var(--green-bg);color:var(--green)}
.rsvp-opt.on-maybe{border-color:var(--amber);background:var(--amber-bg);color:var(--amber)}
.rsvp-opt.on-no{border-color:var(--red);background:var(--red-bg);color:var(--red)}
.item-actions{display:flex;gap:6px;padding:6px 12px 12px}
.btn-edit{flex:1;padding:9px;border-radius:11px;border:2px solid var(--g2);background:#fff;font-family:'Heebo',sans-serif;font-size:.78rem;font-weight:700;color:var(--g4);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px}
.btn-edit:active{background:var(--g1)}
.btn-del{flex:1;padding:9px;border-radius:11px;border:none;background:var(--red-bg);color:var(--red);font-family:'Heebo',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px}
.btn-del:active{background:#fcc}
.div{height:1px;background:var(--g1);margin:0 12px}
.guests-toggle{width:100%;padding:10px 16px;background:none;border:none;text-align:right;font-family:'Heebo',sans-serif;font-size:.76rem;color:var(--g4);font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px}
.guest-row{padding:8px 16px;display:flex;align-items:center;gap:10px;border-top:1px solid var(--g1)}
.g-av{width:30px;height:30px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.64rem;font-weight:900;color:#fff}
.g-fam{font-size:.6rem;font-weight:800;padding:2px 6px;border-radius:5px;color:#fff;margin-right:3px}
.g-status{font-size:.73rem;font-weight:700}
.gy{color:var(--green)}.gn{color:var(--red)}.gm{color:var(--amber)}.gp{color:var(--g3)}
.chat-section{border-top:1px solid var(--g1)}
.chat-toggle{width:100%;padding:10px 16px;background:none;border:none;text-align:right;font-family:'Heebo',sans-serif;font-size:.76rem;color:var(--g4);font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
.chat-body{padding:8px 14px 12px}
.chat-msg{display:flex;gap:8px;margin-bottom:8px;align-items:flex-end}
.chat-msg.mine{flex-direction:row-reverse}
.chat-av{width:26px;height:26px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.56rem;font-weight:900;color:#fff}
.chat-bubble{max-width:72%;padding:7px 11px;border-radius:14px;font-size:.8rem;line-height:1.4;background:var(--g1);color:var(--black);word-break:break-word}
.chat-msg.mine .chat-bubble{background:var(--black);color:#fff}
.chat-name{font-size:.6rem;color:var(--g3);margin-bottom:2px}
.chat-input-row{display:flex;gap:7px;align-items:center;margin-top:6px}
.chat-inp{flex:1;padding:9px 13px;border:2px solid var(--g2);border-radius:20px;font-family:'Heebo',sans-serif;font-size:.86rem;background:var(--g1);color:var(--black);direction:rtl;-webkit-appearance:none;transition:border .2s,background .2s}
.chat-inp:focus{outline:none;border-color:var(--black);background:#fff}
.chat-send{width:36px;height:36px;border-radius:50%;background:var(--black);color:#fff;border:none;font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.pr-top{padding:14px 16px 10px}
.pr-name{font-size:.98rem;font-weight:800;letter-spacing:-.2px;line-height:1.25}
.pr-by{font-size:.68rem;color:var(--g4);margin-top:4px}
.pr-desc{font-size:.8rem;color:var(--g4);line-height:1.5;padding:0 16px 10px}
.prog-wrap{padding:0 16px 10px}
.prog-row{display:flex;justify-content:space-between;font-size:.68rem;font-weight:700;color:var(--g4);margin-bottom:4px}
.prog-track{height:4px;background:var(--g1);border-radius:3px;overflow:hidden}
.prog-fill{height:100%;border-radius:3px;background:var(--black);transition:width .4s ease}
.seg{display:flex;background:var(--g1);border-radius:11px;padding:3px;margin:0 12px 10px}
.seg-b{flex:1;padding:7px 6px;border:none;border-radius:8px;background:none;font-family:'Heebo',sans-serif;font-size:.76rem;font-weight:700;color:var(--g4);cursor:pointer;transition:all .2s}
.seg-b.on{background:#fff;color:var(--black);box-shadow:0 2px 8px rgba(0,0,0,.1)}
.date-opt{padding:11px 16px;display:flex;align-items:center;gap:10px;border-top:1px solid var(--g1)}
.date-opt-info{flex:1}
.date-opt-label{font-size:.84rem;font-weight:700}
.date-opt-votes{font-size:.68rem;color:var(--g4);margin-top:2px}
.vote-btn{padding:5px 12px;border-radius:9px;border:2px solid var(--g2);background:#fff;font-family:'Heebo',sans-serif;font-size:.73rem;font-weight:700;color:var(--g4);cursor:pointer;transition:all .15s}
.vote-btn.on{border-color:var(--black);background:var(--black);color:#fff}
.appr-row{padding:9px 16px;display:flex;align-items:center;gap:10px;border-top:1px solid var(--g1)}
.appr-name{flex:1;font-size:.84rem;font-weight:700}
.appr-acts{display:flex;gap:5px}
.appr-y{padding:5px 11px;border:none;border-radius:8px;font-family:'Heebo',sans-serif;font-size:.7rem;font-weight:700;cursor:pointer;background:var(--green-bg);color:var(--green)}
.appr-n{padding:5px 11px;border:none;border-radius:8px;font-family:'Heebo',sans-serif;font-size:.7rem;font-weight:700;cursor:pointer;background:var(--red-bg);color:var(--red)}
.al-y{font-size:.73rem;font-weight:700;color:var(--green)}
.al-n{font-size:.73rem;font-weight:700;color:var(--red)}
.al-w{font-size:.73rem;font-weight:600;color:var(--g3)}
.convert-row{padding:10px 12px 0}
.convert-btn{width:100%;padding:13px;border-radius:13px;background:var(--black);color:#fff;border:none;font-family:'Heebo',sans-serif;font-size:.9rem;font-weight:800;cursor:pointer}
.cal-wrap{margin:0 12px 12px;background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06),0 4px 14px rgba(0,0,0,.06)}
.cal-nav{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px}
.cal-month{font-size:1.1rem;font-weight:900;letter-spacing:-.3px}
.cal-arrow{width:34px;height:34px;border-radius:10px;background:var(--g1);border:none;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);padding:0 10px 14px;gap:2px}
.cal-dow{font-size:.6rem;font-weight:800;color:var(--g3);text-align:center;padding:2px 0 6px}
.cal-day{min-height:36px;border-radius:9px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:4px 1px 3px;cursor:pointer;transition:background .15s}
.cal-day.other-month .cal-dn{color:var(--g3)}
.cal-day.today .cal-dn{background:var(--black);color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center}
.cal-day.selected{background:var(--g1)}
.cal-dn{font-size:.8rem;font-weight:700;line-height:1}
.cal-dots{display:flex;gap:2px;margin-top:3px;flex-wrap:wrap;justify-content:center}
.cal-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.cal-events-list{border-top:1px solid var(--g1)}
.cal-ev-item{padding:10px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--g1)}
.cal-ev-item:last-child{border-bottom:none}
.cal-ev-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.cal-ev-title{font-size:.84rem;font-weight:700;flex:1}
.cal-ev-time{font-size:.68rem;color:var(--g4)}
.cal-empty{padding:20px;text-align:center;font-size:.8rem;color:var(--g3)}
.fam-section{margin:0 12px 6px}
.fam-section-hdr{display:flex;align-items:center;padding:11px 14px;border-radius:13px 13px 0 0;color:#fff;gap:8px}
.fam-section-name{font-size:.95rem;font-weight:900;display:flex;align-items:center;gap:7px;flex:1}
.fam-section-count{font-size:.68rem;opacity:.6;font-weight:500}
.fam-hdr-btns{display:flex;gap:5px}
.fam-icon-btn{width:28px;height:28px;border-radius:8px;border:none;background:rgba(255,255,255,.2);color:#fff;font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fam-members-block{background:#fff;border-radius:0 0 13px 13px;overflow:hidden;margin-bottom:12px}
.fam-item{padding:12px 14px;display:flex;align-items:center;gap:11px;border-bottom:1px solid var(--g1)}
.fam-item:last-child{border-bottom:none}
.fam-av{width:42px;height:42px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.95rem;font-weight:900;color:#fff}
.fam-info{flex:1}
.fam-name{font-size:.88rem;font-weight:800}
.fam-role{font-size:.68rem;color:var(--g4);margin-top:1px}
.me-tag{background:var(--black);color:#fff;padding:2px 8px;border-radius:6px;font-size:.62rem;font-weight:900}
.fam-item-btns{display:flex;gap:4px}
.fam-icon-btn2{width:28px;height:28px;border-radius:8px;border:none;font-size:.78rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.add-mem-btn{width:100%;padding:10px 14px;border:none;border-top:1px dashed var(--g2);background:none;font-family:'Heebo',sans-serif;font-size:.78rem;font-weight:700;color:var(--g4);cursor:pointer;text-align:right}
.add-fam-btn{margin:0 12px 12px;width:calc(100% - 24px);padding:13px;border:2px dashed var(--g2);border-radius:14px;background:none;font-family:'Heebo',sans-serif;font-size:.84rem;font-weight:700;color:var(--g3);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px}
.ungrouped-section{margin:0 12px 12px}
.ungrouped-hdr{font-size:.68rem;font-weight:800;color:var(--g4);letter-spacing:.4px;text-transform:uppercase;margin-bottom:7px}
.ungrouped-item{background:#fff;border-radius:11px;padding:11px 14px;display:flex;align-items:center;gap:11px;margin-bottom:7px}
.empty{text-align:center;padding:48px 24px;color:var(--g4)}
.empty-ico{font-size:2.8rem;margin-bottom:12px}
.empty-h{font-size:.95rem;font-weight:800;color:var(--black);margin-bottom:5px}
.empty-p{font-size:.8rem;line-height:1.6}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:flex-end;justify-content:center}
.overlay.open{display:flex}
.sheet{background:#fff;border-radius:24px 24px 0 0;width:100%;max-width:430px;max-height:92dvh;overflow-y:auto;-webkit-overflow-scrolling:touch;animation:su .26s cubic-bezier(.32,1.1,.64,1);padding-bottom:calc(var(--safe-b)+18px)}
.sheet::-webkit-scrollbar{display:none}
@keyframes su{from{transform:translateY(100%)}to{transform:none}}
.sheet-pill{width:34px;height:4px;border-radius:2px;background:var(--g2);margin:11px auto 2px}
.sheet-h{font-size:1.15rem;font-weight:900;padding:11px 20px 0;letter-spacing:-.3px}
.sheet-body{padding:14px 20px 0}
.fg{margin-bottom:12px}
label{display:block;font-size:.73rem;font-weight:800;color:var(--g4);margin-bottom:5px;letter-spacing:.2px}
input,textarea,select{width:100%;padding:11px 13px;border:2px solid var(--g1);border-radius:12px;font-family:'Heebo',sans-serif;font-size:.9rem;background:var(--g1);color:var(--black);direction:rtl;transition:border .2s,background .2s;-webkit-appearance:none;appearance:none}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--black);background:#fff}
textarea{min-height:64px;resize:none}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.btn-main{width:100%;padding:14px;margin-top:8px;border-radius:14px;border:none;background:var(--black);color:#fff;font-family:'Heebo',sans-serif;font-size:.94rem;font-weight:800;cursor:pointer}
.btn-main:active{opacity:.8}
.btn-ghost{width:100%;padding:12px;margin-top:6px;border-radius:14px;border:none;background:var(--g1);color:var(--g4);font-family:'Heebo',sans-serif;font-size:.86rem;font-weight:700;cursor:pointer}
.fam-check-grid{display:flex;flex-wrap:wrap;gap:7px}
.fam-check{display:flex;align-items:center;gap:6px;padding:7px 12px;border-radius:11px;border:2px solid var(--g2);background:#fff;cursor:pointer;font-family:'Heebo',sans-serif;font-size:.8rem;font-weight:700;color:var(--g4);transition:all .2s;user-select:none}
.fam-check.on{border-color:var(--black);background:var(--black);color:#fff}
.fam-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.color-picker{display:flex;gap:8px;flex-wrap:wrap}
.cp-swatch{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border .15s;flex-shrink:0}
.cp-swatch.on{border-color:var(--black)}
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:500;align-items:center;justify-content:center;padding:20px}
.confirm-overlay.open{display:flex}
.confirm-box{background:#fff;border-radius:20px;padding:24px 20px;width:100%;max-width:320px;text-align:center;animation:su .2s ease}
.confirm-ico{font-size:2rem;margin-bottom:10px}
.confirm-title{font-size:1rem;font-weight:900;margin-bottom:6px}
.confirm-sub{font-size:.82rem;color:var(--g4);margin-bottom:18px;line-height:1.5;white-space:pre-line}
.confirm-btns{display:flex;gap:8px}
.confirm-yes{flex:1;padding:12px;border-radius:12px;border:none;background:var(--red);color:#fff;font-family:'Heebo',sans-serif;font-size:.9rem;font-weight:800;cursor:pointer}
.confirm-no{flex:1;padding:12px;border-radius:12px;border:none;background:var(--g1);color:var(--g4);font-family:'Heebo',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer}
.who-grid{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}
.who-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:14px;border:2px solid var(--g2);background:#fff;cursor:pointer;transition:all .2s}
.who-item.on{border-color:var(--black);background:var(--black);color:#fff}
.who-item-av{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:900;color:#fff;flex-shrink:0}
.who-item-name{font-size:.9rem;font-weight:800}
.who-item-role{font-size:.7rem;opacity:.6;margin-top:1px}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--g1)}
.settings-row:last-child{border-bottom:none}
.settings-label{font-size:.9rem;font-weight:700}
.settings-sub{font-size:.72rem;color:var(--g4);margin-top:2px}
.font-btns{display:flex;align-items:center;gap:10px}
.font-btn{width:38px;height:38px;border-radius:11px;background:var(--g1);border:none;font-size:1rem;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center}
.font-size-label{font-size:.9rem;font-weight:800;min-width:36px;text-align:center}
.notif-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.48);z-index:300;align-items:flex-start;justify-content:center;padding-top:calc(var(--safe-t)+56px)}
.notif-overlay.open{display:flex}
.notif-panel{background:#fff;border-radius:20px;width:calc(100% - 24px);max-width:400px;max-height:60dvh;overflow-y:auto;animation:ndown .22s ease;box-shadow:0 8px 40px rgba(0,0,0,.18)}
@keyframes ndown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:none}}
.notif-h{padding:14px 16px 11px;font-size:.9rem;font-weight:900;border-bottom:1px solid var(--g1);display:flex;align-items:center;justify-content:space-between}
.notif-close{background:var(--g1);border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center}
.notif-item{padding:11px 16px;border-bottom:1px solid var(--g1);display:flex;gap:10px}
.notif-item:last-child{border-bottom:none}
.notif-txt{flex:1;font-size:.8rem;line-height:1.4}
.notif-time{font-size:.65rem;color:var(--g3);margin-top:2px}
#toast{position:fixed;bottom:calc(var(--nav) + var(--safe-b) + 12px);left:50%;transform:translateX(-50%) translateY(10px);background:var(--black);color:#fff;padding:9px 18px;border-radius:20px;font-size:.83rem;font-weight:700;opacity:0;transition:all .22s cubic-bezier(.34,1.2,.64,1);z-index:999;white-space:nowrap;max-width:calc(100vw - 40px);text-align:center}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div id="loading"><div class="logo">ğŸ¡</div><div class="txt">××©×¤×—×” ×‘×™×—×“</div><div class="spinner"></div></div>
<div id="syncDot"></div>
<div id="app">
  <div class="safe-top"></div>
  <div class="hdr">
    <div class="hdr-row">
      <div><div class="hdr-title">ğŸ¡ ××©×¤×—×” ×‘×™×—×“</div><div class="hdr-sub">××™×¨×•×¢×™× Â· ×ª×™××•× Â· ×–×›×¨×•× ×•×ª</div></div>
      <div class="hdr-btns">
        <button class="hdr-btn" onclick="openSheet('sh-settings')">âš™ï¸</button>
        <button class="hdr-btn" onclick="toggleNotif()">ğŸ””<div class="bell-pip" id="bellPip"></div></button>
      </div>
    </div>
  </div>
  <div class="who-bar" onclick="openSheet('sh-who')">
    <div class="who-av" id="whoAv" style="background:#555">?</div>
    <div class="who-name" id="whoName">×‘×—×¨ ××ª ×¢×¦××š</div>
    <div class="who-change">×”×—×œ×£</div>
  </div>
  <div class="filter-bar" id="filterBar"></div>
  <div class="scroll" id="scroll">
    <div id="pg-events" class="page on">
      <div class="pg-hdr">
        <div><div class="pg-label">××™×¨×•×¢×™×</div><div class="pg-sub" id="ev-sub">×›×œ ×”××™×¨×•×¢×™×</div></div>
        <button class="pg-add" onclick="openSheet('sh-ev')">ï¼‹</button>
      </div>
      <div id="evList"></div>
    </div>
    <div id="pg-proposals" class="page">
      <div class="pg-hdr">
        <div><div class="pg-label">×”×¦×¢×•×ª</div><div class="pg-sub">×”×¦×‘×¢×” ×•××™×©×•×¨×™×</div></div>
        <button class="pg-add" onclick="openSheet('sh-pr')">ï¼‹</button>
      </div>
      <div id="prList"></div>
    </div>
    <div id="pg-calendar" class="page">
      <div class="pg-hdr"><div><div class="pg-label">×œ×•×— ×©× ×”</div><div class="pg-sub">×‘×—×¨ ×™×•×</div></div></div>
      <div class="cal-wrap">
        <div class="cal-nav">
          <button class="cal-arrow" onclick="calShift(-1)">â€º</button>
          <div class="cal-month" id="calMonthLabel"></div>
          <button class="cal-arrow" onclick="calShift(1)">â€¹</button>
        </div>
        <div class="cal-grid" id="calGrid"></div>
        <div class="cal-events-list" id="calEvList"><div class="cal-empty">×‘×—×¨ ×™×•× ×œ×¨××•×ª ××™×¨×•×¢×™×</div></div>
      </div>
    </div>
    <div id="pg-family" class="page">
      <div class="pg-hdr">
        <div><div class="pg-label">××©×¤×—×”</div><div class="pg-sub" id="famSub"></div></div>
        <button class="pg-add" onclick="openSheet('sh-grp')">ï¼‹</button>
      </div>
      <div id="famContent"></div>
    </div>
  </div>
  <div class="nav">
    <button class="nav-btn on" id="nav-events" onclick="goPage('events',this)"><span class="nav-icon">ğŸ‰<span class="nav-pip" id="evPip"></span></span><span>××™×¨×•×¢×™×</span><div class="nav-tick"></div></button>
    <button class="nav-btn" id="nav-proposals" onclick="goPage('proposals',this)"><span class="nav-icon">ğŸ’¡<span class="nav-pip" id="prPip"></span></span><span>×”×¦×¢×•×ª</span><div class="nav-tick"></div></button>
    <button class="nav-btn" id="nav-calendar" onclick="goPage('calendar',this)"><span class="nav-icon">ğŸ“…</span><span>×œ×•×— ×©× ×”</span><div class="nav-tick"></div></button>
    <button class="nav-btn" id="nav-family" onclick="goPage('family',this)"><span class="nav-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span>××©×¤×—×”</span><div class="nav-tick"></div></button>
  </div>
</div>

<div class="notif-overlay" id="notifOverlay" onclick="if(event.target===this)closeNotif()">
  <div class="notif-panel">
    <div class="notif-h"><span>×”×ª×¨××•×ª ğŸ””</span><button class="notif-close" onclick="closeNotif()">âœ•</button></div>
    <div id="notifList"></div>
  </div>
</div>

<div class="overlay" id="sh-ev" onclick="if(event.target===this)closeSheet('sh-ev')">
<div class="sheet"><div class="sheet-pill"></div><div class="sheet-h">××™×¨×•×¢ ×—×“×© âœ¨</div>
<div class="sheet-body">
  <div class="fg"><label>×©× ×”××™×¨×•×¢</label><input id="e-title" type="text" placeholder="×œ××©×œ: ××¨×•×—×ª ×©×™×©×™"></div>
  <div class="fg"><label>×¡×•×’</label><select id="e-type"><option>ğŸ½ï¸ ××¨×•×—×” ××©×¤×—×ª×™×ª</option><option>ğŸ‚ ×™×•× ×”×•×œ×“×ª</option><option>ğŸŒŠ ×˜×™×•×œ / × ×¡×™×¢×”</option><option>ğŸŠ ×—×’×™×’×”</option><option>â˜• ××¤×’×© ×§×‘×•×¢</option><option>ğŸ“¸ ×ª×™×¢×•×“ / ×–×™×›×¨×•×Ÿ</option><option>××—×¨</option></select></div>
  <div class="row2"><div class="fg"><label>×ª××¨×™×š</label><input id="e-date" type="date"></div><div class="fg"><label>×©×¢×”</label><input id="e-time" type="time" value="18:00"></div></div>
  <div class="fg"><label>××™×§×•×</label><input id="e-loc" type="text" placeholder="×›×ª×•×‘×ª / ×©× ××§×•×"></div>
  <div class="fg"><label>×”×¢×¨×•×ª</label><textarea id="e-note" placeholder="××” ×œ×”×‘×™×, ×¤×¨×˜×™×..."></textarea></div>
  <div class="fg"><label>ğŸ  ×”×–××Ÿ ××©×¤×—×•×ª</label><div class="fam-check-grid" id="e-fam-checks"></div></div>
  <button class="btn-main" onclick="doAddEvent()">×©××•×¨ ××™×¨×•×¢ ğŸ‰</button>
  <button class="btn-ghost" onclick="closeSheet('sh-ev')">×‘×™×˜×•×œ</button>
</div></div></div>

<div class="overlay" id="sh-ev-edit" onclick="if(event.target===this)closeSheet('sh-ev-edit')">
<div class="sheet"><div class="sheet-pill"></div><div class="sheet-h">×¢×¨×™×›×ª ××™×¨×•×¢ âœï¸</div>
<div class="sheet-body">
  <div class="fg"><label>×©× ×”××™×¨×•×¢</label><input id="ee-title" type="text"></div>
  <div class="fg"><label>×¡×•×’</label><select id="ee-type"><option>ğŸ½ï¸ ××¨×•×—×” ××©×¤×—×ª×™×ª</option><option>ğŸ‚ ×™×•× ×”×•×œ×“×ª</option><option>ğŸŒŠ ×˜×™×•×œ / × ×¡×™×¢×”</option><option>ğŸŠ ×—×’×™×’×”</option><option>â˜• ××¤×’×© ×§×‘×•×¢</option><option>ğŸ“¸ ×ª×™×¢×•×“ / ×–×™×›×¨×•×Ÿ</option><option>××—×¨</option></select></div>
  <div class="row2"><div class="fg"><label>×ª××¨×™×š</label><input id="ee-date" type="date"></div><div class="fg"><label>×©×¢×”</label><input id="ee-time" type="time"></div></div>
  <div class="fg"><label>××™×§×•×</label><input id="ee-loc" type="text"></div>
  <div class="fg"><label>×”×¢×¨×•×ª</label><textarea id="ee-note"></textarea></div>
  <button class="btn-main" onclick="doSaveEditEvent()">×©××•×¨ ×©×™× ×•×™×™× âœ…</button>
  <button class="btn-ghost" onclick="closeSheet('sh-ev-edit')">×‘×™×˜×•×œ</button>
</div></div></div>

<div class="overlay" id="sh-pr" onclick="if(event.target===this)closeSheet('sh-pr')">
<div class="sheet"><div class="sheet-pill"></div><div class="sheet-h">×”×¦×¢×” ×—×“×©×” ğŸ’¡</div>
<div class="sheet-body">
  <div class="fg"><label>×©× ×”×¤×¢×™×œ×•×ª</label><input id="p-title" type="text" placeholder="×œ××©×œ: ×™×•× ×›×™×£ ×‘×¤××¨×§"></div>
  <div class="fg"><label>×ª×™××•×¨</label><textarea id="p-desc" placeholder="×¡×¤×¨×• ×¢×œ ×”×¨×¢×™×•×Ÿ..."></textarea></div>
  <div class="fg"><label>××™×§×•× ××•×¦×¢</label><input id="p-loc" type="text" placeholder="××™×¤×”?"></div>
  <div class="fg"><label>××¤×©×¨×•×™×•×ª ×ª××¨×™×›×™×</label><div style="display:flex;flex-direction:column;gap:7px"><input class="d-inp" type="date"><input class="d-inp" type="date"><input class="d-inp" type="date"></div></div>
  <div class="fg"><label>ğŸ  ×”×–××Ÿ ××©×¤×—×•×ª</label><div class="fam-check-grid" id="p-fam-checks"></div></div>
  <button class="btn-main" onclick="doAddProposal()">×©×œ×— ×œ××©×¤×—×” ğŸ“¨</button>
  <button class="btn-ghost" onclick="closeSheet('sh-pr')">×‘×™×˜×•×œ</button>
</div></div></div>

<div class="overlay" id="sh-grp" onclick="if(event.target===this)closeSheet('sh-grp')">
<div class="sheet"><div class="sheet-pill"></div><div class="sheet-h">××©×¤×—×” ×—×“×©×” ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
<div class="sheet-body">
  <div class="fg"><label>×©× ×”××©×¤×—×”</label><input id="g-name" type="text" placeholder="×œ××©×œ: ××©×¤×—×ª ×›×”×Ÿ"></div>
  <div class="fg"><label>×××•×’×³×™</label><input id="g-emoji" type="text" placeholder="ğŸ¡" maxlength="4" style="font-size:1.4rem;text-align:center"></div>
  <div class="fg"><label>×¦×‘×¢</label><div class="color-picker" id="colorPicker"></div></div>
  <button class="btn-main" onclick="doAddGroup()">×¦×•×¨ ××©×¤×—×” âœ…</button>
  <button class="btn-ghost" onclick="closeSheet('sh-grp')">×‘×™×˜×•×œ</button>
</div></div></div>

<div class="overlay" id="sh-grp-edit" onclick="if(event.target===this)closeSheet('sh-grp-edit')">
<div class="sheet"><div class="sheet-pill"></div><div class="sheet-h">×¢×¨×™×›×ª ××©×¤×—×” âœï¸</div>
<div class="sheet-body">
  <div class="fg"><label>×©× ×”××©×¤×—×”</label><input id="eg-name" type="text"></div>
  <div class="fg"><label>×××•×’×³×™</label><input id="eg-emoji" type="text" maxlength="4" style="font-size:1.4rem;text-align:center"></div>
  <div class="fg"><label>×¦×‘×¢</label><div class="color-picker" id="colorPickerEdit"></div></div>
  <button class="btn-main" onclick="doSaveEditGroup()">×©××•×¨ ×©×™× ×•×™×™× âœ…</button>
  <button class="btn-ghost" onclick="closeSheet('sh-grp-edit')">×‘×™×˜×•×œ</button>
</div></div></div>

<div class="overlay" id="sh-mem" onclick="if(event.target===this)closeSheet('sh-mem')">
<div class="sheet"><div class="sheet-pill"></div><div class="sheet-h" id="sh-mem-title">×”×•×¡×¤×ª ×‘×Ÿ ××©×¤×—×” ğŸ‘¤</div>
<div class="sheet-body">
  <div class="fg"><label>×©× ××œ×</label><input id="m-name" type="text" placeholder="×©× ×¤×¨×˜×™ ×•×©× ××©×¤×—×”"></div>
  <div class="row2"><div class="fg"><label>×§×©×¨</label><select id="m-role"><option>××‘/××</option><option>×‘×Ÿ/×‘×ª</option><option>××—/××—×•×ª</option><option>×¡×‘/×¡×‘×ª×</option><option>×“×•×“/×“×•×“×”</option><option>×‘×Ÿ/×‘×ª ×–×•×’</option><option>××—×¨</option></select></div><div class="fg"><label>×˜×œ×¤×•×Ÿ</label><input id="m-phone" type="tel" placeholder="050-0000000"></div></div>
  <div class="fg"><label>×©×™×™×š ×œ××©×¤×—×”</label><select id="m-group"></select></div>
  <button class="btn-main" onclick="doAddMember()">×”×•×¡×£ âœ…</button>
  <button class="btn-ghost" onclick="closeSheet('sh-mem')">×‘×™×˜×•×œ</button>
</div></div></div>

<div class="overlay" id="sh-mem-edit" onclick="if(event.target===this)closeSheet('sh-mem-edit')">
<div class="sheet"><div class="sheet-pill"></div><div class="sheet-h">×¢×¨×™×›×ª ×‘×Ÿ ××©×¤×—×” âœï¸</div>
<div class="sheet-body">
  <div class="fg"><label>×©× ××œ×</label><input id="em-name" type="text"></div>
  <div class="row2"><div class="fg"><label>×§×©×¨</label><select id="em-role"><option>××‘/××</option><option>×‘×Ÿ/×‘×ª</option><option>××—/××—×•×ª</option><option>×¡×‘/×¡×‘×ª×</option><option>×“×•×“/×“×•×“×”</option><option>×‘×Ÿ/×‘×ª ×–×•×’</option><option>××—×¨</option></select></div><div class="fg"><label>×˜×œ×¤×•×Ÿ</label><input id="em-phone" type="tel"></div></div>
  <div class="fg"><label>×©×™×™×š ×œ××©×¤×—×”</label><select id="em-group"></select></div>
  <button class="btn-main" onclick="doSaveEditMember()">×©××•×¨ ×©×™× ×•×™×™× âœ…</button>
  <button class="btn-ghost" onclick="closeSheet('sh-mem-edit')">×‘×™×˜×•×œ</button>
</div></div></div>

<div class="overlay" id="sh-who" onclick="if(event.target===this)closeSheet('sh-who')">
<div class="sheet"><div class="sheet-pill"></div><div class="sheet-h">××™ ××ª×”? ğŸ‘¤</div>
<div class="sheet-body">
  <p style="font-size:.82rem;color:var(--g4);margin-bottom:14px">×‘×—×¨ ××ª ×¢×¦××š ×›×“×™ ×©×”××¤×œ×™×§×¦×™×” ×ª×“×¢ ××™ ××ª×”</p>
  <div class="who-grid" id="whoGrid"></div>
  <button class="btn-ghost" onclick="closeSheet('sh-who')">×‘×™×˜×•×œ</button>
</div></div></div>

<div class="overlay" id="sh-settings" onclick="if(event.target===this)closeSheet('sh-settings')">
<div class="sheet"><div class="sheet-pill"></div><div class="sheet-h">×”×’×“×¨×•×ª âš™ï¸</div>
<div class="sheet-body">
  <div class="settings-row">
    <div><div class="settings-label">×’×•×“×œ ×˜×§×¡×˜</div><div class="settings-sub">×”×ª×× ×œ× ×•×—×•×ª ×”×§×¨×™××”</div></div>
    <div class="font-btns">
      <button class="font-btn" onclick="changeFontSize(-1)">Aâˆ’</button>
      <div class="font-size-label" id="fontSizeLabel">100%</div>
      <button class="font-btn" onclick="changeFontSize(1)">A+</button>
    </div>
  </div>
  <div class="settings-row">
    <div><div class="settings-label">××™×¤×•×¡ ×’×•×“×œ</div></div>
    <button class="font-btn" onclick="resetFontSize()" style="width:auto;padding:0 14px;font-size:.8rem;font-weight:800">××™×¤×•×¡</button>
  </div>
  <div style="margin-top:8px;background:var(--g1);border-radius:12px;padding:12px 14px">
    <div style="font-size:.8rem;font-weight:800;margin-bottom:4px">×ª×¦×•×’×” ××§×“×™××”</div>
    <div style="font-size:.9rem;color:var(--g4);line-height:1.6">××¨×•×—×ª ×©×™×©×™ ××©×¤×—×ª×™×ª<br>×™×•× ×”×•×œ×“×ª ×œ×¡×‘× ğŸ‚</div>
  </div>
  <button class="btn-ghost" onclick="closeSheet('sh-settings')" style="margin-top:14px">×¡×’×•×¨</button>
</div></div></div>

<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-ico">ğŸ—‘ï¸</div>
    <div class="confirm-title" id="confirmTitle">×œ××—×•×§?</div>
    <div class="confirm-sub" id="confirmSub">×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ</div>
    <div class="confirm-btns">
      <button class="confirm-no" onclick="closeConfirm()">×‘×™×˜×•×œ</button>
      <button class="confirm-yes" id="confirmYesBtn">××—×§</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import{getDatabase,ref,push,onValue,update,remove}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig={apiKey:"AIzaSyASkWoFdjrAnPzYqFld7WRiOQp-Q37tWjM",authDomain:"blasstrbuta.firebaseapp.com",databaseURL:"https://blasstrbuta-default-rtdb.europe-west1.firebasedatabase.app",projectId:"blasstrbuta",storageBucket:"blasstrbuta.firebasestorage.app",messagingSenderId:"744163679862",appId:"1:744163679862:web:59cf67d63f710b496f0957"};
const FB=initializeApp(firebaseConfig);
const DB=getDatabase(FB);

const PAL=['#1a1a1a','#c0392b','#2d6a4f','#d4783a','#2980b9','#8e44ad','#16a085','#e67e22','#7f8c8d'];
const TC={'ğŸ½ï¸ ××¨×•×—×” ××©×¤×—×ª×™×ª':'#1a1a1a','ğŸ‚ ×™×•× ×”×•×œ×“×ª':'#c0392b','ğŸŒŠ ×˜×™×•×œ / × ×¡×™×¢×”':'#2d6a4f','ğŸŠ ×—×’×™×’×”':'#d4783a','â˜• ××¤×’×© ×§×‘×•×¢':'#2980b9','ğŸ“¸ ×ª×™×¢×•×“ / ×–×™×›×¨×•×Ÿ':'#8e44ad','××—×¨':'#7f8c8d','ğŸŒŸ ×××•×©×¨':'#2d6a4f'};
const HE_M=['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
const HE_D=['×','×‘','×’','×“','×”','×•','×©'];

let groups=[],members=[],events=[],proposals=[],notifications=[];
let meId=localStorage.getItem('mp_me')||null;
let activeFilter='all';
let selColor=PAL[0],editColor=PAL[0];
let addToGrpId=null,editEvId=null,editMemId=null,editGrpId=null;
let calY=new Date().getFullYear(),calM=new Date().getMonth(),calD=null;

// FONT SIZE
const FS=[80,90,100,115,130,150];
let fIdx=parseInt(localStorage.getItem('mp_font')||'2');
function applyFont(){document.documentElement.style.fontSize=(FS[fIdx]/100*16)+'px';const l=document.getElementById('fontSizeLabel');if(l)l.textContent=FS[fIdx]+'%';localStorage.setItem('mp_font',fIdx);}
window.changeFontSize=d=>{fIdx=Math.max(0,Math.min(FS.length-1,fIdx+d));applyFont();};
window.resetFontSize=()=>{fIdx=2;applyFont();toast('âœ… ×’×•×“×œ ×˜×§×¡×˜ ××•×¤×¡');};
applyFont();

// SYNC
const sync=s=>{const d=document.getElementById('syncDot');d.className=s==='ok'?'':s;};
sync('ok');

// LISTENERS â€” no seeding, pure reactive
onValue(ref(DB,'groups'),s=>{groups=s.val()?Object.entries(s.val()).map(([id,v])=>({id,...v})):[];buildFilterBar();renderFamily();rebuildFC();});
onValue(ref(DB,'members'),s=>{members=s.val()?Object.entries(s.val()).map(([id,v])=>({id,...v})):[];updateWhoBar();renderFamily();rebuildFC();renderWhoGrid();});
onValue(ref(DB,'events'),s=>{events=s.val()?Object.entries(s.val()).map(([id,v])=>({id,...v})):[];events.sort((a,b)=>a.date>b.date?1:-1);renderEvents();renderCalendar();});
onValue(ref(DB,'proposals'),s=>{proposals=s.val()?Object.entries(s.val()).map(([id,v])=>({id,...v})):[];renderProposals();});
onValue(ref(DB,'notifications'),s=>{notifications=s.val()?Object.entries(s.val()).map(([id,v])=>({id,...v})):[];notifications.sort((a,b)=>b.ts-a.ts);updateBell();});

setTimeout(()=>{const l=document.getElementById('loading');if(l){l.classList.add('hide');setTimeout(()=>l.remove(),400);}},1000);

// HELPERS
const gm=id=>members.find(m=>m.id===id);
const gg=id=>groups.find(g=>g.id===id);
const ini=n=>n?n.split(' ').map(w=>w[0]).join('').slice(0,2):'?';
const fmtD=d=>{if(!d)return'?';return new Date(d+'T00:00:00').toLocaleDateString('he-IL',{weekday:'short',day:'numeric',month:'long'});};
const fmtDL=d=>{if(!d)return'';return new Date(d+'T00:00:00').toLocaleDateString('he-IL',{weekday:'long',day:'numeric',month:'long',year:'numeric'});};
const memsFor=item=>{if(!item.invitedGroups)return members;const inv=Array.isArray(item.invitedGroups)?item.invitedGroups:Object.values(item.invitedGroups);return inv.length?members.filter(m=>inv.includes(m.groupId)):members;};
const visible=item=>{if(activeFilter==='all')return true;if(!item.invitedGroups)return true;const inv=Array.isArray(item.invitedGroups)?item.invitedGroups:Object.values(item.invitedGroups);return!inv.length||inv.includes(activeFilter);};

// WHO BAR
function updateWhoBar(){const m=gm(meId);const av=document.getElementById('whoAv');if(m){av.textContent=ini(m.name);av.style.background=m.color;document.getElementById('whoName').textContent=m.name+' Â· '+m.role;}else{av.textContent='?';av.style.background='#555';document.getElementById('whoName').textContent='×‘×—×¨ ××ª ×¢×¦××š';}}
function renderWhoGrid(){const g=document.getElementById('whoGrid');if(!g)return;g.innerHTML=members.map(m=>`<div class="who-item ${m.id===meId?'on':''}" onclick="pickMe('${m.id}')"><div class="who-item-av" style="background:${m.color}">${ini(m.name)}</div><div><div class="who-item-name">${m.name}</div><div class="who-item-role">${m.role}${gg(m.groupId)?' Â· '+gg(m.groupId).name:''}</div></div></div>`).join('');}
window.pickMe=id=>{meId=id;localStorage.setItem('mp_me',id);updateWhoBar();renderEvents();renderProposals();closeSheet('sh-who');toast('ğŸ‘‹ ×©×œ×•× '+gm(id)?.name+'!');};

// FILTER BAR
function buildFilterBar(){
  const bar=document.getElementById('filterBar');bar.innerHTML='';
  const mk=(txt,fid,color)=>{const b=document.createElement('button');b.className='fb-btn'+(activeFilter===fid?' on':'');b.textContent=txt;if(activeFilter===fid&&color){b.style.background=color;b.style.borderColor=color;b.style.color='#fff';}b.onclick=()=>{activeFilter=fid;buildFilterBar();document.getElementById('ev-sub').textContent=fid==='all'?'×›×œ ×”××™×¨×•×¢×™×':txt;renderEvents();renderProposals();};bar.appendChild(b);};
  mk('ğŸ  ×”×›×œ','all',null);groups.forEach(g=>mk(g.emoji+' '+g.name,g.id,g.color));
}

// BREAKDOWN
function breakdown(ev,mems){
  const fm={};mems.forEach(m=>{const k=m.groupId||'_';if(!fm[k])fm[k]=[];fm[k].push(m);});
  if(Object.keys(fm).length<2)return'';
  return`<div class="fam-breakdown"><div class="fam-breakdown-hdr">××’×™×¢×™× ×œ×¤×™ ×¡× ×™×£</div>${Object.keys(fm).map(gid=>{const g=gg(gid);const ms=fm[gid];const rsvps=ev.rsvps||{};const yes=ms.filter(m=>rsvps[m.id]==='yes').length;const avs=ms.map(m=>{const s=rsvps[m.id];return`<div class="fam-bd-av" style="background:${m.color};opacity:${s==='yes'?1:s==='no'?.3:.55}">${ini(m.name)}</div>`;}).join('');return`<div class="fam-bd-row"><div class="fam-bd-name"><div class="fam-bd-dot" style="background:${g?g.color:'#888'}"></div>${g?g.emoji+' '+g.name:'××—×¨×™×'}</div><div class="fam-bd-avatars">${avs}</div><div class="fam-bd-count">${yes}/${ms.length} âœ…</div></div>`;}).join('')}</div>`;
}

// CHAT
function buildChat(ev){
  const arr=Object.entries(ev.chat||{}).map(([id,v])=>({id,...v})).sort((a,b)=>(a.ts||'').localeCompare(b.ts||''));
  const msgs=arr.map(c=>{const m=gm(c.memberId);if(!m)return'';const mine=c.memberId===meId;return`<div class="chat-msg ${mine?'mine':''}"><div class="chat-av" style="background:${m.color}">${ini(m.name)}</div><div>${!mine?`<div class="chat-name">${m.name.split(' ')[0]}</div>`:''}<div class="chat-bubble">${c.text}</div></div></div>`;}).join('');
  return`<div class="chat-body"><div>${msgs||'<div style="text-align:center;padding:10px;font-size:.76rem;color:var(--g3)">×”×™×” ×¨××©×•×Ÿ ×œ×›×ª×•×‘ ğŸ’¬</div>'}</div><div class="chat-input-row"><input class="chat-inp" id="ci-${ev.id}" type="text" placeholder="×›×ª×•×‘ ×”×¢×¨×”..." onkeydown="if(event.key==='Enter')sendChat('${ev.id}')"><button class="chat-send" onclick="sendChat('${ev.id}')">â¤</button></div></div>`;
}
window.sendChat=async evId=>{
  if(!meId){toast('âš ï¸ ×‘×—×¨ ××ª ×¢×¦××š ×§×•×“×');openSheet('sh-who');return;}
  const inp=document.getElementById('ci-'+evId);const text=(inp?.value||'').trim();if(!text)return;inp.value='';
  const now=new Date();sync('syncing');
  await push(ref(DB,`events/${evId}/chat`),{memberId:meId,text,ts:now.getHours()+':'+String(now.getMinutes()).padStart(2,'0')});
  sync('ok');
};

// RENDER EVENTS
function renderEvents(){
  const el=document.getElementById('evList');const list=events.filter(visible);
  if(!list.length){el.innerHTML='<div class="empty"><div class="empty-ico">ğŸ“…</div><div class="empty-h">××™×Ÿ ××™×¨×•×¢×™×</div><div class="empty-p">×œ×—×¥ ï¼‹ ×œ×”×•×¡×¤×”</div></div>';pip('evPip',0);return;}
  el.innerHTML=list.map(ev=>{
    const mems=memsFor(ev);const rsvps=ev.rsvps||{};
    const yes=mems.filter(m=>rsvps[m.id]==='yes').length,no=mems.filter(m=>rsvps[m.id]==='no').length,maybe=mems.filter(m=>rsvps[m.id]==='maybe').length,pend=mems.filter(m=>!rsvps[m.id]).length;
    const myS=meId?rsvps[meId]||null:null;const color=TC[ev.type]||'#1a1a1a';
    const inv=ev.invitedGroups?(Array.isArray(ev.invitedGroups)?ev.invitedGroups:Object.values(ev.invitedGroups)):null;
    const scope=inv&&inv.length?inv.map(gid=>{const g=gg(gid);return g?`<span class="inv-tag" style="background:${g.color}">${g.emoji} ${g.name}</span>`:''}).join(''):'<span class="inv-tag inv-tag-all">ğŸ  ×›×œ ×”××©×¤×—×•×ª</span>';
    const gRows=mems.map(m=>{const s=rsvps[m.id]||null;const g=gg(m.groupId);const lbl=s==='yes'?'âœ… ××’×™×¢':s==='no'?'âŒ ×œ×':s==='maybe'?'ğŸ¤” ××•×œ×™':'â³ ×××ª×™×Ÿ';const cls=s==='yes'?'gy':s==='no'?'gn':s==='maybe'?'gm':'gp';return`<div class="guest-row"><div class="g-av" style="background:${m.color}">${ini(m.name)}</div><div style="flex:1"><div style="font-size:.83rem;font-weight:600">${m.name}${g?`<span class="g-fam" style="background:${g.color}">${g.emoji}</span>`:''}</div><div style="font-size:.66rem;color:var(--g3)">${m.role}${m.id===meId?' Â· ××ª×”':''}</div></div><div class="g-status ${cls}">${lbl}</div></div>`;}).join('');
    const cc=ev.chat?Object.keys(ev.chat).length:0;
    const id=ev.id;const t=ev.title.replace(/'/g,"\\'");
    return`<div class="card"><div class="ev-strip" style="background:${color}"></div><div class="ev-top"><div class="ev-name">${ev.title}</div><div class="ev-meta"><span>ğŸ“… ${fmtD(ev.date)} Â· â° ${ev.time||''}</span><span>ğŸ“ ${ev.location||'××™×§×•× ×œ× × ×§×‘×¢'}</span></div></div><div class="invited-fams">${scope}</div>${ev.note?`<div class="ev-note">ğŸ“ ${ev.note}</div>`:''}${breakdown(ev,mems)}<div class="stats"><div class="stat"><div class="stat-n cg">${yes}</div><div class="stat-l">××’×™×¢×™×</div></div><div class="stat"><div class="stat-n cr">${no}</div><div class="stat-l">×œ×</div></div><div class="stat"><div class="stat-n ca">${maybe}</div><div class="stat-l">××•×œ×™</div></div><div class="stat"><div class="stat-n cm">${pend}</div><div class="stat-l">×××ª×™× ×™×</div></div></div><div class="div"></div><div class="ev-actions"><button class="rsvp-opt ${myS==='yes'?'on-yes':''}" onclick="setRSVP('${id}','yes')">âœ… ××’×™×¢</button><button class="rsvp-opt ${myS==='maybe'?'on-maybe':''}" onclick="setRSVP('${id}','maybe')">ğŸ¤” ××•×œ×™</button><button class="rsvp-opt ${myS==='no'?'on-no':''}" onclick="setRSVP('${id}','no')">âŒ ×œ×</button></div><details><summary class="guests-toggle">ğŸ‘¥ ××©×ª×ª×¤×™× (${mems.length}) â–¾</summary>${gRows}</details><div class="chat-section"><details><summary class="chat-toggle"><span>ğŸ’¬ ×”×¢×¨×•×ª${cc?` (${cc})`:''}</span><span style="font-size:.7rem">â–¾</span></summary>${buildChat(ev)}</details></div><div class="item-actions"><button class="btn-edit" onclick="openEditEvent('${id}')">âœï¸ ×¢×¨×•×š</button><button class="btn-del" onclick="confirmDel('event','${id}','${t}')">ğŸ—‘ï¸ ××—×§</button></div></div>`;
  }).join('');
  pip('evPip',meId?events.filter(ev=>memsFor(ev).some(m=>m.id===meId)&&!(ev.rsvps||{})[meId]).length:0);
}

// RENDER PROPOSALS
function renderProposals(){
  const el=document.getElementById('prList');const list=proposals.filter(visible);
  if(!list.length){el.innerHTML='<div class="empty"><div class="empty-ico">ğŸ’¡</div><div class="empty-h">××™×Ÿ ×”×¦×¢×•×ª</div><div class="empty-p">×”×’×© ×”×¦×¢×” ×—×“×©×”</div></div>';pip('prPip',0);return;}
  el.innerHTML=list.map(pr=>{
    const mems=memsFor(pr);const proposer=gm(pr.proposedBy);const appr=pr.approvals||{};
    const approved=mems.filter(m=>appr[m.id]==='yes').length,total=mems.length,pend=mems.filter(m=>!appr[m.id]).length;
    const dv=pr.dateVotes||{};let maxV=0,winIdx=0;(pr.dateOptions||[]).forEach((_,i)=>{if((dv[i]||[]).length>maxV){maxV=(dv[i]||[]).length;winIdx=i;}});
    const inv=pr.invitedGroups?(Array.isArray(pr.invitedGroups)?pr.invitedGroups:Object.values(pr.invitedGroups)):null;
    const scope=inv&&inv.length?inv.map(gid=>{const g=gg(gid);return g?`<span class="inv-tag" style="background:${g.color}">${g.emoji} ${g.name}</span>`:''}).join(''):'<span class="inv-tag inv-tag-all">ğŸ  ×›×œ ×”××©×¤×—×•×ª</span>';
    const dRows=(pr.dateOptions||[]).map((d,i)=>{const votes=(dv[i]||[]).length;const iV=meId&&(dv[i]||[]).includes(meId);return`<div class="date-opt"><div class="date-opt-info"><div class="date-opt-label">${i===winIdx&&maxV>0?'ğŸ† ':''}${fmtDL(d)}</div><div class="date-opt-votes">${votes} ×”×¦×‘×¢×•×ª</div></div><button class="vote-btn ${iV?'on':''}" onclick="voteDate('${pr.id}',${i})">${iV?'âœ“':'×”×¦×‘×¢'}</button></div>`;}).join('');
    const aRows=mems.map(m=>{const s=appr[m.id];const g=gg(m.groupId);let c;if(m.id===meId&&!s){c=`<div class="appr-acts"><button class="appr-y" onclick="myApprove('${pr.id}','yes')">âœ…</button><button class="appr-n" onclick="myApprove('${pr.id}','no')">âŒ</button></div>`;}else{c=s==='yes'?'<span class="al-y">âœ…</span>':s==='no'?'<span class="al-n">âŒ</span>':'<span class="al-w">â³</span>';}return`<div class="appr-row"><div class="g-av" style="background:${m.color};width:28px;height:28px;font-size:.6rem;flex-shrink:0">${ini(m.name)}</div><div class="appr-name">${m.name}${g?` <span style="font-size:.6rem;font-weight:800;color:${g.color}">${g.emoji}</span>`:''}</div>${c}</div>`;}).join('');
    const allOk=approved===total&&total>0;const t=pr.title.replace(/'/g,"\\'");
    return`<div class="card"><div class="pr-top"><div class="pr-name">${pr.title}</div><div class="pr-by">×”×•×¦×¢ ×¢"×™ ${proposer?.name||'?'} Â· ${pend} ×××ª×™× ×™×</div></div><div class="invited-fams">${scope}</div>${pr.desc?`<div class="pr-desc">${pr.desc}</div>`:''}<div class="prog-wrap"><div class="prog-row"><span>××™×©×•×¨×™×</span><span>${approved}/${total}</span></div><div class="prog-track"><div class="prog-fill" style="width:${total?(approved/total)*100:0}%"></div></div></div><div class="seg"><button class="seg-b on" onclick="swSeg(this,'sd-${pr.id}','sa-${pr.id}')">ğŸ“… ×ª××¨×™×›×™×</button><button class="seg-b" onclick="swSeg(this,'sa-${pr.id}','sd-${pr.id}')">âœ… ××™×©×•×¨×™×</button></div><div id="sd-${pr.id}">${dRows}</div><div id="sa-${pr.id}" style="display:none">${aRows}</div>${allOk?`<div class="convert-row"><button class="convert-btn" onclick="convertToEvent('${pr.id}')">ğŸ‰ ×›×•×œ× ××™×©×¨×•! ×¦×•×¨ ××™×¨×•×¢</button></div>`:''}<div class="item-actions"><button class="btn-del" style="flex:1;justify-content:center" onclick="confirmDel('proposal','${pr.id}','${t}')">ğŸ—‘ï¸ ××—×§ ×”×¦×¢×”</button></div></div>`;
  }).join('');
  pip('prPip',meId?proposals.filter(pr=>memsFor(pr).some(m=>m.id===meId)&&!(pr.approvals||{})[meId]).length:0);
}

// RENDER FAMILY
function renderFamily(){
  const el=document.getElementById('famContent');if(!el)return;
  document.getElementById('famSub').textContent=groups.length+' ×§×‘×•×¦×•×ª Â· '+members.length+' ×—×‘×¨×™×';
  let html='';
  groups.forEach(g=>{
    const gms=members.filter(m=>m.groupId===g.id);
    const mHtml=gms.map(m=>`<div class="fam-item"><div class="fam-av" style="background:${m.color}">${ini(m.name)}</div><div class="fam-info"><div class="fam-name">${m.name}</div><div class="fam-role">${m.role}</div></div>${m.id===meId?'<span class="me-tag">××ª×”</span>':`<div class="fam-item-btns"><button class="fam-icon-btn2" style="background:var(--g1);color:var(--g4)" onclick="openEditMember('${m.id}')">âœï¸</button><button class="fam-icon-btn2" style="background:var(--red-bg);color:var(--red)" onclick="confirmDel('member','${m.id}','${m.name.replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button></div>`}</div>`).join('');
    html+=`<div class="fam-section"><div class="fam-section-hdr" style="background:${g.color}"><div class="fam-section-name">${g.emoji} ${g.name} <span class="fam-section-count">${gms.length} ×—×‘×¨×™×</span></div><div class="fam-hdr-btns"><button class="fam-icon-btn" onclick="openEditGroup('${g.id}')">âœï¸</button><button class="fam-icon-btn" onclick="confirmDel('group','${g.id}','${g.name.replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button></div></div><div class="fam-members-block">${mHtml}<button class="add-mem-btn" onclick="openAddMember('${g.id}')">ï¼‹ ×”×•×¡×£ ×œ${g.name}</button></div></div>`;
  });
  const ung=members.filter(m=>!m.groupId||!gg(m.groupId));
  if(ung.length){html+=`<div class="ungrouped-section"><div class="ungrouped-hdr">×œ×œ× ×§×‘×•×¦×”</div>${ung.map(m=>`<div class="ungrouped-item"><div class="fam-av" style="background:${m.color}">${ini(m.name)}</div><div class="fam-info"><div class="fam-name">${m.name}</div><div class="fam-role">${m.role}</div></div>${m.id===meId?'<span class="me-tag">××ª×”</span>':`<div class="fam-item-btns"><button class="fam-icon-btn2" style="background:var(--g1);color:var(--g4)" onclick="openEditMember('${m.id}')">âœï¸</button><button class="fam-icon-btn2" style="background:var(--red-bg);color:var(--red)" onclick="confirmDel('member','${m.id}','${m.name.replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button></div>`}</div>`).join('')}</div>`;}
  html+=`<button class="add-fam-btn" onclick="openSheet('sh-mem')">ï¼‹ ×”×•×¡×£ ×‘×Ÿ ××©×¤×—×”</button>`;
  el.innerHTML=html;
}

// CALENDAR
function renderCalendar(){
  document.getElementById('calMonthLabel').textContent=HE_M[calM]+' '+calY;
  const today=new Date();const evByD={};
  events.forEach(ev=>{if(!ev.date)return;const dt=new Date(ev.date+'T00:00:00');if(dt.getFullYear()===calY&&dt.getMonth()===calM){const k=dt.getDate();if(!evByD[k])evByD[k]=[];evByD[k].push(ev);}});
  const first=new Date(calY,calM,1).getDay(),last=new Date(calY,calM+1,0).getDate();
  let c=HE_D.map(d=>`<div class="cal-dow">${d}</div>`).join('');
  for(let i=0;i<first;i++)c+=`<div class="cal-day other-month"><div class="cal-dn"></div></div>`;
  for(let d=1;d<=last;d++){const isT=d===today.getDate()&&calM===today.getMonth()&&calY===today.getFullYear();const dots=(evByD[d]||[]).map(ev=>`<div class="cal-dot" style="background:${TC[ev.type]||'#888'}"></div>`).join('');c+=`<div class="cal-day ${isT?'today':''} ${calD===d?'selected':''}" onclick="calSel(${d})"><div class="cal-dn">${d}</div>${dots?`<div class="cal-dots">${dots}</div>`:''}</div>`;}
  document.getElementById('calGrid').innerHTML=c;
  const cel=document.getElementById('calEvList');if(!calD){cel.innerHTML='<div class="cal-empty">×‘×—×¨ ×™×•× ×œ×¨××•×ª ××™×¨×•×¢×™×</div>';return;}
  const ds=`${calY}-${String(calM+1).padStart(2,'0')}-${String(calD).padStart(2,'0')}`;
  const day=events.filter(ev=>ev.date===ds);
  cel.innerHTML=day.length?day.map(ev=>`<div class="cal-ev-item"><div class="cal-ev-dot" style="background:${TC[ev.type]||'#888'}"></div><div class="cal-ev-title">${ev.title}</div><div class="cal-ev-time">${ev.time||''}</div></div>`).join(''):`<div class="cal-empty">××™×Ÿ ××™×¨×•×¢×™× ×‘-${calD} ×‘${HE_M[calM]}</div>`;
}
window.calSel=d=>{calD=d;renderCalendar();};
window.calShift=dir=>{calM+=dir;if(calM>11){calM=0;calY++;}if(calM<0){calM=11;calY--;}calD=null;renderCalendar();};

// FAM CHECKS
function rebuildFC(){buildFC('e-fam-checks');buildFC('p-fam-checks');}
function buildFC(cid,sel){
  const c=document.getElementById(cid);if(!c)return;c.innerHTML='';
  const all=mk2('all','×›×œ ×”××©×¤×—×•×ª','#1a1a1a',!sel||!sel.length,c);
  all.onclick=()=>{c.querySelectorAll('.fam-check').forEach(b=>b.classList.remove('on'));all.classList.add('on');};
  groups.forEach(g=>{const b=mk2(g.id,g.emoji+' '+g.name,g.color,sel&&sel.includes(g.id),c);b.onclick=()=>{all.classList.remove('on');b.classList.toggle('on');if(!c.querySelectorAll('.fam-check.on').length)all.classList.add('on');};});
}
function mk2(gid,txt,color,on,parent){const b=document.createElement('div');b.className='fam-check'+(on?' on':'');b.dataset.gid=gid;b.innerHTML=`<div class="fam-dot" style="background:${color}"></div>${txt}`;parent.appendChild(b);return b;}
function getSelF(cid){const c=document.getElementById(cid);if(!c)return null;if(c.querySelector('[data-gid="all"]')?.classList.contains('on'))return null;const s=[];c.querySelectorAll('.fam-check.on').forEach(b=>{if(b.dataset.gid!=='all')s.push(b.dataset.gid);});return s.length?s:null;}

// COLOR PICKERS
function buildCP(cid,cur){document.getElementById(cid).innerHTML=PAL.map(c=>`<div class="cp-swatch ${c===cur?'on':''}" style="background:${c}" onclick="pickCP('${cid}','${c}',this)"></div>`).join('');if(cid==='colorPicker')selColor=cur||PAL[0];else editColor=cur||PAL[0];}
window.pickCP=(cid,c,el)=>{document.querySelectorAll(`#${cid} .cp-swatch`).forEach(s=>s.classList.remove('on'));el.classList.add('on');if(cid==='colorPicker')selColor=c;else editColor=c;};
function buildGrpSel(sid,pre){document.getElementById(sid).innerHTML='<option value="">×œ×œ× ×§×‘×•×¦×”</option>'+groups.map(g=>`<option value="${g.id}" ${pre===g.id?'selected':''}>${g.emoji} ${g.name}</option>`).join('');}

// SHEETS
window.openSheet=id=>{
  if(id==='sh-ev')buildFC('e-fam-checks');
  if(id==='sh-pr')buildFC('p-fam-checks');
  if(id==='sh-grp')buildCP('colorPicker',PAL[0]);
  if(id==='sh-mem'&&!addToGrpId){document.getElementById('sh-mem-title').textContent='×”×•×¡×¤×ª ×‘×Ÿ ××©×¤×—×” ğŸ‘¤';buildGrpSel('m-group',null);}
  if(id==='sh-who')renderWhoGrid();
  document.getElementById(id).classList.add('open');
};
window.closeSheet=id=>{document.getElementById(id).classList.remove('open');addToGrpId=null;};
window.openAddMember=gid=>{addToGrpId=gid;const g=gg(gid);document.getElementById('sh-mem-title').textContent='×”×•×¡×¤×ª ×‘×Ÿ ××©×¤×—×” ×œ'+(g?.name||'')+' ğŸ‘¤';buildGrpSel('m-group',gid);document.getElementById('sh-mem').classList.add('open');};

// EDIT OPENERS
window.openEditEvent=evId=>{const ev=events.find(e=>e.id===evId);if(!ev)return;editEvId=evId;document.getElementById('ee-title').value=ev.title||'';document.getElementById('ee-type').value=ev.type||'';document.getElementById('ee-date').value=ev.date||'';document.getElementById('ee-time').value=ev.time||'';document.getElementById('ee-loc').value=ev.location||'';document.getElementById('ee-note').value=ev.note||'';document.getElementById('sh-ev-edit').classList.add('open');};
window.openEditMember=memId=>{const m=gm(memId);if(!m)return;editMemId=memId;document.getElementById('em-name').value=m.name||'';document.getElementById('em-role').value=m.role||'';document.getElementById('em-phone').value=m.phone||'';buildGrpSel('em-group',m.groupId);document.getElementById('sh-mem-edit').classList.add('open');};
window.openEditGroup=grpId=>{const g=gg(grpId);if(!g)return;editGrpId=grpId;document.getElementById('eg-name').value=g.name||'';document.getElementById('eg-emoji').value=g.emoji||'';buildCP('colorPickerEdit',g.color);document.getElementById('sh-grp-edit').classList.add('open');};

// SAVE EDITS
window.doSaveEditEvent=async()=>{if(!editEvId)return;const title=document.getElementById('ee-title').value.trim();if(!title){toast('âš ï¸ × × ×œ××œ× ×©×');return;}sync('syncing');await update(ref(DB,'events/'+editEvId),{title,type:document.getElementById('ee-type').value,date:document.getElementById('ee-date').value,time:document.getElementById('ee-time').value,location:document.getElementById('ee-loc').value,note:document.getElementById('ee-note').value});sync('ok');closeSheet('sh-ev-edit');toast('âœ… ×”××™×¨×•×¢ ×¢×•×“×›×Ÿ!');};
window.doSaveEditMember=async()=>{if(!editMemId)return;const name=document.getElementById('em-name').value.trim();if(!name){toast('âš ï¸ × × ×œ××œ× ×©×');return;}sync('syncing');await update(ref(DB,'members/'+editMemId),{name,role:document.getElementById('em-role').value,phone:document.getElementById('em-phone').value,groupId:document.getElementById('em-group').value||null});sync('ok');if(editMemId===meId)updateWhoBar();closeSheet('sh-mem-edit');toast('âœ… ×”×¤×¨×˜×™× ×¢×•×“×›× ×•!');};
window.doSaveEditGroup=async()=>{if(!editGrpId)return;const name=document.getElementById('eg-name').value.trim();if(!name){toast('âš ï¸ × × ×œ××œ× ×©×');return;}sync('syncing');await update(ref(DB,'groups/'+editGrpId),{name,emoji:document.getElementById('eg-emoji').value.trim()||'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',color:editColor});sync('ok');closeSheet('sh-grp-edit');toast('âœ… ×”×§×‘×•×¦×” ×¢×•×“×›× ×”!');};

// CONFIRM DELETE
let _cb=null;
window.confirmDel=(type,id,name)=>{
  const t={event:'××—×§ ××™×¨×•×¢',member:'××—×§ ×‘×Ÿ ××©×¤×—×”',proposal:'××—×§ ×”×¦×¢×”',group:'××—×§ ×§×‘×•×¦×”'};
  document.getElementById('confirmTitle').textContent=t[type]||'××—×§';
  document.getElementById('confirmSub').textContent='×œ××—×•×§ ××ª "'+name+'"?\n×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.';
  _cb=()=>execDel(type,id);
  document.getElementById('confirmYesBtn').onclick=()=>{closeConfirm();_cb&&_cb();};
  document.getElementById('confirmOverlay').classList.add('open');
};
window.closeConfirm=()=>{document.getElementById('confirmOverlay').classList.remove('open');_cb=null;};
async function execDel(type,id){
  sync('syncing');
  if(type==='event')await remove(ref(DB,'events/'+id));
  else if(type==='proposal')await remove(ref(DB,'proposals/'+id));
  else if(type==='member'){await remove(ref(DB,'members/'+id));if(meId===id){meId=null;localStorage.removeItem('mp_me');updateWhoBar();}}
  else if(type==='group'){await remove(ref(DB,'groups/'+id));for(const m of members.filter(m=>m.groupId===id))await remove(ref(DB,'members/'+m.id));}
  sync('ok');toast('ğŸ—‘ï¸ × ××—×§ ×‘×”×¦×œ×—×”');
}

// ADD ACTIONS
window.doAddEvent=async()=>{const title=document.getElementById('e-title').value.trim();if(!title){toast('âš ï¸ × × ×œ××œ× ×©×');return;}const inv=getSelF('e-fam-checks');const mems=inv?members.filter(m=>inv.includes(m.groupId)):members;const rsvps={};mems.forEach(m=>{rsvps[m.id]=m.id===meId?'yes':null;});sync('syncing');await push(ref(DB,'events'),{title,type:document.getElementById('e-type').value,date:document.getElementById('e-date').value,time:document.getElementById('e-time').value,location:document.getElementById('e-loc').value,note:document.getElementById('e-note').value,invitedGroups:inv||null,rsvps,chat:{}});await push(ref(DB,'notifications'),{text:'××™×¨×•×¢ ×—×“×©: "'+title+'"',ts:Date.now(),unread:true});sync('ok');closeSheet('sh-ev');['e-title','e-loc','e-note'].forEach(id=>document.getElementById(id).value='');toast('ğŸ‰ ×”××™×¨×•×¢ × ×•×¡×£!');};
window.doAddProposal=async()=>{const title=document.getElementById('p-title').value.trim();if(!title){toast('âš ï¸ × × ×œ××œ× ×©×');return;}const dates=Array.from(document.querySelectorAll('.d-inp')).map(d=>d.value).filter(Boolean);const inv=getSelF('p-fam-checks');const mems=inv?members.filter(m=>inv.includes(m.groupId)):members;const approvals={},dateVotes={};mems.forEach(m=>{approvals[m.id]=m.id===meId?'yes':null;});(dates.length?dates:['2025-09-01']).forEach((_,i)=>{dateVotes[i]=[];});sync('syncing');await push(ref(DB,'proposals'),{title,desc:document.getElementById('p-desc').value,location:document.getElementById('p-loc').value,proposedBy:meId||'?',invitedGroups:inv||null,dateOptions:dates.length?dates:['2025-09-01'],dateVotes,approvals});sync('ok');closeSheet('sh-pr');['p-title','p-desc','p-loc'].forEach(id=>document.getElementById(id).value='');document.querySelectorAll('.d-inp').forEach(i=>i.value='');toast('ğŸ“¨ ×”×”×¦×¢×” × ×©×œ×—×”!');};
window.doAddGroup=async()=>{const name=document.getElementById('g-name').value.trim();if(!name){toast('âš ï¸ × × ×œ××œ× ×©×');return;}sync('syncing');await push(ref(DB,'groups'),{name,emoji:document.getElementById('g-emoji').value.trim()||'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',color:selColor});sync('ok');closeSheet('sh-grp');document.getElementById('g-name').value='';document.getElementById('g-emoji').value='';toast('âœ… ×”×§×‘×•×¦×” × ×•×¦×¨×”!');};
window.doAddMember=async()=>{const name=document.getElementById('m-name').value.trim();if(!name){toast('âš ï¸ × × ×œ××œ× ×©×');return;}const gid=document.getElementById('m-group').value||null;const col=gid&&gg(gid)?gg(gid).color:PAL[members.length%PAL.length];sync('syncing');await push(ref(DB,'members'),{name,role:document.getElementById('m-role').value,phone:document.getElementById('m-phone').value,groupId:gid,color:col});sync('ok');addToGrpId=null;closeSheet('sh-mem');document.getElementById('m-name').value='';toast('ğŸ‘¤ '+name+' × ×•×¡×£/×”!');};

// RSVP / VOTE / APPROVE
window.setRSVP=async(evId,status)=>{if(!meId){toast('âš ï¸ ×‘×—×¨ ××ª ×¢×¦××š ×§×•×“×');openSheet('sh-who');return;}const ev=events.find(e=>e.id===evId);if(!ev)return;const cur=(ev.rsvps||{})[meId];const nv=cur===status?null:status;sync('syncing');await update(ref(DB,`events/${evId}/rsvps`),{[meId]:nv});sync('ok');toast(nv===null?'×‘×•×˜×œ':status==='yes'?'âœ… ××™×©×¨×ª!':status==='no'?'âŒ ×œ× ××’×™×¢':'ğŸ¤” ××•×œ×™');};
window.voteDate=async(prId,idx)=>{if(!meId){toast('âš ï¸ ×‘×—×¨ ××ª ×¢×¦××š ×§×•×“×');openSheet('sh-who');return;}const pr=proposals.find(p=>p.id===prId);if(!pr)return;const votes=[...((pr.dateVotes||{})[idx]||[])];const i=votes.indexOf(meId);if(i>=0)votes.splice(i,1);else votes.push(meId);sync('syncing');await update(ref(DB,`proposals/${prId}/dateVotes`),{[idx]:votes});sync('ok');toast(i>=0?'×”×¦×‘×¢×” ×”×•×¡×¨×”':'ğŸ—³ï¸ ×”×¦×‘×¢×ª!');};
window.myApprove=async(prId,d)=>{if(!meId){toast('âš ï¸ ×‘×—×¨ ××ª ×¢×¦××š ×§×•×“×');openSheet('sh-who');return;}sync('syncing');await update(ref(DB,`proposals/${prId}/approvals`),{[meId]:d});sync('ok');toast(d==='yes'?'âœ… ××™×©×¨×ª!':'âŒ ×”×ª× ×’×“×•×ª × ×¨×©××”');};
window.convertToEvent=async prId=>{const pr=proposals.find(p=>p.id===prId);if(!pr)return;const dv=pr.dateVotes||{};let maxV=0,winIdx=0;(pr.dateOptions||[]).forEach((_,i)=>{if((dv[i]||[]).length>maxV){maxV=(dv[i]||[]).length;winIdx=i;}});const mems=memsFor(pr);const rsvps={};mems.forEach(m=>{rsvps[m.id]=(pr.approvals||{})[m.id]==='yes'?'yes':null;});sync('syncing');await push(ref(DB,'events'),{title:pr.title,type:'ğŸŒŸ ×××•×©×¨',date:(pr.dateOptions||[])[winIdx]||'',time:'18:00',location:pr.location||'',note:pr.desc||'',invitedGroups:pr.invitedGroups||null,rsvps,chat:{}});await remove(ref(DB,'proposals/'+prId));sync('ok');goPage('events',document.getElementById('nav-events'));toast('ğŸ‰ ×”××™×¨×•×¢ × ×•×¦×¨!');};

// NOTIFICATIONS
function updateBell(){const u=notifications.filter(n=>n.unread).length;document.getElementById('bellPip').classList.toggle('show',u>0);}
window.toggleNotif=()=>{const o=document.getElementById('notifOverlay');if(o.classList.contains('open')){closeNotif();return;}document.getElementById('notifList').innerHTML=notifications.length?notifications.slice(0,20).map(n=>`<div class="notif-item"><div style="width:7px;height:7px;border-radius:50%;background:var(--black);flex-shrink:0;margin-top:4px;opacity:${n.unread?1:.3}"></div><div class="notif-txt">${n.text}<div class="notif-time">${new Date(n.ts||Date.now()).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})}</div></div></div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--g4);font-size:.83rem">××™×Ÿ ×”×ª×¨××•×ª</div>';o.classList.add('open');};
window.closeNotif=()=>document.getElementById('notifOverlay').classList.remove('open');

// NAV
window.goPage=(name,btn)=>{document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('on'));document.getElementById('pg-'+name).classList.add('on');btn.classList.add('on');document.getElementById('scroll').scrollTop=0;if(name==='family')renderFamily();if(name==='calendar')renderCalendar();};
window.swSeg=(btn,show,hide)=>{btn.parentElement.querySelectorAll('.seg-b').forEach(b=>b.classList.remove('on'));btn.classList.add('on');document.getElementById(show).style.display='block';document.getElementById(hide).style.display='none';};
const pip=(id,n)=>{const p=document.getElementById(id);p.textContent=n;p.classList.toggle('show',n>0);};

let _t;
const toast=msg=>{clearTimeout(_t);const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');_t=setTimeout(()=>el.classList.remove('show'),2500);};
window.toast=toast;

setTimeout(()=>{if(!meId&&members.length>0)openSheet('sh-who');},2000);
</script>
</body>
</html>
